/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var w=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var _=(o,t)=>{for(var a in t)w(o,a,{get:t[a],enumerable:!0})},I=(o,t,a,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of H(t))!N.call(o,r)&&r!==a&&w(o,r,{get:()=>t[r],enumerable:!(e=k(t,r))||e.enumerable});return o};var F=o=>I(w({},"__esModule",{value:!0}),o);var z={};_(z,{default:()=>b});module.exports=F(z);var L=require("obsidian");var f=class{parseStarRatings(t){let a=[],e;for(f.STAR_REGEX.lastIndex=0;(e=f.STAR_REGEX.exec(t))!==null;){let r=this.validateAttribute(e[1]),n=this.validateRating(parseInt(e[2]));r&&a.push({attribute:r,rating:n,rawText:e[0],startPos:e.index,endPos:e.index+e[0].length})}return a}validateAttribute(t){return!t||t.length>f.ATTRIBUTE_MAX_LENGTH||!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(t)?null:t}validateRating(t){return Math.max(0,Math.min(5,t||0))}createStarRatingSyntax(t,a){let e=this.validateAttribute(t),r=this.validateRating(a);if(!e)throw new Error(`Invalid attribute name: ${t}`);return`{{stars:${e}:${r}}}`}},m=f;m.STAR_REGEX=/\{\{stars:([a-zA-Z_][a-zA-Z0-9_]*):(\d+)\}\}/g,m.ATTRIBUTE_MAX_LENGTH=50;var E=class{constructor(){this.config={maxStars:5,filledIcon:"\u2B50",emptyIcon:"\u2606",showValue:!0}}createStarElement(t){let a=document.createElement("span");a.className="star-rating-container",a.setAttribute("data-attribute",t.attribute),a.setAttribute("data-rating",t.rating.toString());let e=document.createElement("span");e.className="star-rating-stars";for(let r=1;r<=this.config.maxStars;r++){let n=this.createStar(r,t.rating);e.appendChild(n)}if(a.appendChild(e),this.config.showValue){let r=document.createElement("span");r.className="star-rating-value",r.textContent=` ${t.rating}/5`,a.appendChild(r)}return a}createStar(t,a){let e=document.createElement("span");return e.className="star-rating-star",e.setAttribute("data-position",t.toString()),e.setAttribute("role","button"),e.setAttribute("tabindex","0"),e.setAttribute("aria-label",`Rate ${t} out of 5 stars`),this.updateStarState(e,t,a),e}updateStarState(t,a,e){let r=a<=e;t.textContent=r?this.config.filledIcon:this.config.emptyIcon,t.className=`star-rating-star ${r?"filled":"empty"}`}updateRatingDisplay(t,a){t.querySelectorAll(".star-rating-star").forEach((n,s)=>{this.updateStarState(n,s+1,a)});let r=t.querySelector(".star-rating-value");r&&(r.textContent=` ${a}/5`),t.setAttribute("data-rating",a.toString())}addHoverEffects(t){t.querySelectorAll(".star-rating-star").forEach((e,r)=>{e.addEventListener("mouseenter",()=>{this.previewRating(t,r+1)}),e.addEventListener("mouseleave",()=>{this.resetPreview(t)})})}previewRating(t,a){t.querySelectorAll(".star-rating-star").forEach((r,n)=>{let s=n+1,i=r;s<=a?(i.style.color="#ffd700",i.style.filter="brightness(1.2)"):(i.style.color="#718096",i.style.filter="none")})}resetPreview(t){t.querySelectorAll(".star-rating-star").forEach(e=>{let r=e;r.style.color="",r.style.filter=""})}};var M=require("obsidian"),x=class{constructor(t,a,e,r){this.app=t;this.parser=a;this.renderer=e;this.metadataManager=r}attachEventListeners(t,a){t.querySelectorAll(".star-rating-star").forEach((r,n)=>{let s=r,i=n+1;s.addEventListener("click",async()=>{await this.handleStarClick(t,a,i)}),s.addEventListener("keydown",async c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),await this.handleStarClick(t,a,i))})}),this.renderer.addHoverEffects(t)}async handleStarClick(t,a,e){try{console.log(`\u2B50 Clicked star ${e} for ${a.attribute}`),this.renderer.updateRatingDisplay(t,e),await this.updateMarkdownSource(a,e),await this.updateMetadata(a.attribute,e),new M.Notice(`${a.attribute}: ${e}/5`)}catch(r){console.error("Failed to update star rating:",r),new M.Notice("Failed to save rating. Please try again."),this.renderer.updateRatingDisplay(t,a.rating)}}async updateMarkdownSource(t,a){let e=this.app.workspace.getActiveFile();if(!e)throw new Error("No active file");let r=await this.app.vault.read(e),n=this.parser.createStarRatingSyntax(t.attribute,a),s=r.replace(t.rawText,n);await this.app.vault.modify(e,s),t.rating=a,t.rawText=n,console.log(`\u{1F4DD} Updated ${t.attribute} to ${a}/5`)}async updateMetadata(t,a){let e=this.app.workspace.getActiveFile();if(!e)return;let r=await this.app.vault.read(e),n=this.metadataManager.updateInlineMetadata(r,t,a);r!==n&&(await this.app.vault.modify(e,n),console.log(`\u{1F3F7}\uFE0F Updated metadata: (${t}:: ${a})`))}};var R=class{updateInlineMetadata(t,a,e){let r=new RegExp(`\\(${this.escapeRegex(a)}::\\s*\\d+\\)`,"g"),n=`(${a}:: ${e})`;if(r.test(t))return t.replace(r,n);{let s=new RegExp(`\\{\\{stars:${this.escapeRegex(a)}:\\d+\\}\\}`,"g");return t.replace(s,i=>`${i} ${n}`)}}extractMetadata(t){let a=/\(([a-zA-Z_][a-zA-Z0-9_]*)::\s*(\d+)\)/g,e=[];return t.split(`
`).forEach((n,s)=>{let i;for(;(i=a.exec(n))!==null;)e.push({attribute:i[1],value:parseInt(i[2]),line:s,text:i[0]})}),e}cleanupOrphanedMetadata(t){let a=this.extractMetadata(t),e=this.extractStarRatingAttributes(t),r=a.filter(s=>!e.includes(s.attribute)),n=t;return r.forEach(s=>{n=n.replace(s.text,"")}),n}extractStarRatingAttributes(t){let a=/\{\{stars:([a-zA-Z_][a-zA-Z0-9_]*):\d+\}\}/g,e=[],r;for(;(r=a.exec(t))!==null;)e.includes(r[1])||e.push(r[1]);return e}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var u=require("@codemirror/view"),h=require("@codemirror/state"),A=class extends u.WidgetType{constructor(a,e,r){super();this.data=a;this.renderer=e;this.controller=r}toDOM(){let a=this.renderer.createStarElement(this.data);return this.controller.attachEventListeners(a,this.data),a}eq(a){return this.data.attribute===a.data.attribute&&this.data.rating===a.data.rating}ignoreEvent(){return!1}},C=h.StateEffect.define(),T=null,D=300;function P(o,t,a){let e=h.StateField.define({create(){return u.Decoration.none},update(n,s){for(let l of s.effects)if(l.is(C))return l.value;if(!s.docChanged)return n.map(s.changes);let i=!1;if(s.changes.iterChanges((l,d,g,S,p)=>{let v=p.toString();(v.includes("{{stars:")||v.includes("}}"))&&(i=!0)}),!i)return n.map(s.changes);T&&clearTimeout(T);let c=n.map(s.changes);return T=window.setTimeout(()=>{T=null},D),c}}),r=u.ViewPlugin.fromClass(class{constructor(n){this.updateTimeout=null;this.decorations=n.state.field(e),this.scheduleUpdate(n)}update(n){if(this.decorations=n.state.field(e),n.docChanged){let s=!1;n.changes.iterChanges((i,c,l,d,g)=>{let S=g.toString(),p=n.state.doc,v=p.lineAt(l),$=p.lineAt(d);for(let y=v.number;y<=$.number;y++)if(p.line(y).text.includes("{{stars:")||S.includes("{{stars:")){s=!0;break}}),s&&this.scheduleUpdate(n.view)}}scheduleUpdate(n){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=window.setTimeout(()=>{let s=U(n.state.doc,o,t,a);n.dispatch({effects:C.of(s)}),this.updateTimeout=null},D)}destroy(){this.updateTimeout&&clearTimeout(this.updateTimeout)}},{decorations:n=>n.decorations});return[e,r]}function U(o,t,a,e){let r=new h.RangeSetBuilder;for(let n=1;n<=o.lines;n++){let s=o.line(n),i=s.text;i.includes("{{stars:")&&t.parseStarRatings(i).forEach(l=>{let d=s.from+l.startPos,g=s.from+l.endPos,S=new A(l,a,e),p=u.Decoration.replace({widget:S,inclusive:!1});r.add(d,g,p)})}return r.finish()}var b=class extends L.Plugin{async onload(){console.log("\u{1F31F} Loading Star Rating Plugin"),this.parser=new m,this.renderer=new E,this.metadataManager=new R,this.controller=new x(this.app,this.parser,this.renderer,this.metadataManager),console.log("\u{1F4CB} Registering markdown post processor"),this.registerMarkdownPostProcessor(this.processStarRatings.bind(this)),console.log("\u2705 Markdown post processor registered"),console.log("\u{1F50A} Registering editor extension");let a=P(this.parser,this.renderer,this.controller);this.registerEditorExtension(a),console.log("\u2705 Editor extension registered"),this.addStyles(),this.addCommand({id:"insert-star-rating",name:"Insert Star Rating",editorCallback:e=>{let r=e.getCursor(),n="{{stars:attribute_name:0}}";e.replaceRange(n,r);let s={line:r.line,ch:r.ch+8},i={line:r.line,ch:r.ch+22};e.setSelection(s,i)}})}onunload(){console.log("\u2B50 Unloading Star Rating Plugin")}processStarRatings(a,e){this.getTextNodes(a).forEach(n=>{let s=n.textContent||"";if(s.includes("{{stars:")){let i=n.parentElement;if(!i)return;let c=this.parser.parseStarRatings(s);c.length>0&&this.replaceWithStarComponents(i,n,s,c)}})}getTextNodes(a){var s;let e=[],r=document.createTreeWalker(a,NodeFilter.SHOW_TEXT),n;for(;n=r.nextNode();)(s=n.textContent)!=null&&s.includes("{{stars:")&&e.push(n);return e}replaceWithStarComponents(a,e,r,n){let s=r,i=0,c=document.createDocumentFragment();if(n.forEach(l=>{if(l.startPos>i){let g=s.slice(i,l.startPos);c.appendChild(document.createTextNode(g))}let d=this.renderer.createStarElement(l);this.controller.attachEventListeners(d,l),c.appendChild(d),i=l.endPos}),i<s.length){let l=s.slice(i);c.appendChild(document.createTextNode(l))}a.replaceChild(c,e)}addStyles(){let a=`
        .star-rating-container {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin: 0 4px;
        }

        .star-rating-stars {
            display: inline-flex;
            gap: 1px;
        }

        .star-rating-star {
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            padding: 2px;
            border-radius: 2px;
        }

        .star-rating-star:hover {
            transform: scale(1.1);
        }

        .star-rating-star:focus {
            outline: 2px solid var(--interactive-accent);
            outline-offset: 1px;
        }

        .star-rating-star.filled {
            color: #ffd700;
        }

        .star-rating-star.empty {
            color: var(--text-muted);
        }

        .star-rating-value {
            font-size: 0.9em;
            color: var(--text-muted);
            font-weight: 500;
            margin-left: 4px;
        }

        /* Dark theme adjustments */
        .theme-dark .star-rating-star.empty {
            color: #718096;
        }
        `,e=document.createElement("style");e.textContent=a,document.head.appendChild(e)}};
